# https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions
name: Perl Tests, Lint, and Coverage on all versions and OSes
on:
  push:
    # this workflow is somewhat expensive, so only run when explicitly tagged
    tags:
      - '**'
jobs:
  all-ver:
    name: Perl ${{ matrix.perlver }} on Linux
    strategy:
      fail-fast: false
      matrix:
        perlver:
          # this list is generated by dev/allver-test/perlver.pl
          - 5.8.9-buster
          - 5.10.1-buster
          - 5.12-buster
          - 5.14-buster
          - 5.16-buster
          - 5.18-buster
          - 5.20-buster
          - 5.22-buster
          - 5.24-buster
          - 5.26-buster
          - 5.28-buster
          - 5.30-bullseye
          - 5.32-bullseye
          - 5.34-bullseye
          - 5.36-bookworm
          - 5.38-bookworm
    runs-on: ubuntu-latest
    container:
      image: perl:${{ matrix.perlver }}
    steps:
      - uses: actions/checkout@v4
      - id: cache-perl-modules
        uses: actions/cache@v4
        with:
          path: /usr/src/perl-modules
          key: ${{ hashFiles('dev/allver-test/modules.txt') }}
      - name: Download dependencies
        if: steps.cache-perl-modules.outputs.cache-hit != 'true'
        working-directory: ./pl
        run: wget --content-disposition --timestamping --directory-prefix=/usr/src/perl-modules --input-file=dev/allver-test/modules.txt
      - name: Install dependencies
        working-directory: ./pl
        run: cpanm --notest /usr/src/perl-modules/*.tar.gz
      - name: Tests
        working-directory: ./pl
        run: prove -l
  all-os:
    # Uses the Perl that comes preinstalled on all GH Action runners
    # https://github.com/actions/runner-images?tab=readme-ov-file#available-images
    name: Default Perl on ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [Ubuntu, Windows, macOS]
    runs-on: ${{ matrix.os }}-latest
    steps:
      - uses: actions/checkout@v4
      - name: Tests
        working-directory: ./pl
        run: prove -l
  author-tests:
    # Using the Perl that is preinstalled on the GH Action Runner is a bit of
    # a pain here because cpanm isn't installed and we don't have root, and
    # just using a Perl container is easier than setting up local::lib.
    name: Perl 5.38 on Linux
    runs-on: ubuntu-latest
    container:
      image: perl:5.38
    steps:
      - uses: actions/checkout@v4
      - name: Install dependencies
        working-directory: ./pl/xt
        #TODO: This takes a long time, can we cache it?
        run: cpanm --installdeps .
      - name: Tests and author tests
        working-directory: ./pl
        run: prove -l t xt
      - name: Coverage
        working-directory: ./pl
        run: perl Makefile.PL && make authorcover
